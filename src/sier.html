<!doctype html>
<html lang="en">

    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Bohao Chu, and Bootstrap contributors">
    <title>SIER | Bohao Chu</title>
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom style sheet -->
    <link type="text/css" rel="stylesheet" href="assets/css/style.css"/>

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:700%7CNunito:300,600" rel="stylesheet">

    <!--Title Icon-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Highlight JS -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<link rel="stylesheet" href="assets/highlight/styles/default.min.css">
	<script src="assets/highlight/highlight.min.js"></script>
	
	<script src="assets/js/bootstrap.bundle.min.js"></script>
	<script>
		hljs.highlightAll();
		addEventListener("DOMContentLoaded", function() {
			$(".header").load("components/header.html",function(){});
			$(".footer").load("components/footer.html",function(){});
		});
	</script>
    </head>


    <body>

        <header class="fixed-top header"></header>

		<main>
			<div class="section px-0">
				<div id="post-header" class="page-header page-header-light pt-5" style="background-image: url('assets/img/sier/bg.png'); background-color: #100c2a; background-position-x: 85%; background-position-y: 90%; background-size: auto 80%">
					<div class="container">
						<div class="row">
							<div class="col-md-10 col-sm-11 post-meta">
								<a class="post-category cat-5" href="#">Web Server</a>
								<span class="post-date text-light">July, 2023</span>
								<br><br>
								<h1 class="text-light">GPT SIER</h1>
								<h3 class="text-light pt-3">
									Personal Chatbot based on GPT 3.5 Turbo Natural Language Large Model.
								</h3>
								<p>
									<span class="text-light">
										Bohao Chu, Yousong Chu
									</span>
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="section px-0">
				<!-- container -->
				<div class="container">
					<!-- row -->
					<div class="row">
						<!-- POST MAIN -->
						<div class="col-md-8 pe-5">

							<h3>INTRODUCTION</h3>
							<a href="http://bohao.de:8992" class="btn btn-primary my-3">
								<i class="bi bi-signpost-fill me-2"></i>
								GPT SIER
							</a>

							<div class="row">
								<h4>
									BACKGROUND
								</h4>
								<p>
									The GPT model is a natural language processing model based on deep learning, which has unprecedented powerful language generation capabilities. This model can process a large amount of text data, and can learn language rules and patterns from it, and then generate text content with grammatical correctness, context coherence and logic. Compared with previous natural language processing technologies, the GPT model is closer to the understanding and expression of human language.
								</p>
								<p>
									When the GPT model came out, it represented a major milestone in AI technology, as it showed that AI could interact and communicate with humans through natural language. This is an unprecedented challenge to human intelligence, and it also means that the knowledge accumulated by humans over thousands of years can become the basis for further training of AI. At the same time, this knowledge is more structured and logical, which opens a new door for the application of artificial intelligence.
								</p>

								<h4>
									MOTIVATION & GOALS
								</h4>
								<p>
									This work deploys a personal chatbot based on the GPT-3.5 Turbo API. Multiple rounds of dialogue are possible (I set up 5 rounds), as well as streaming responses. In July, I will be experimenting with the GPT-4 model, along with speech recognition and image generation.
								</p>

								<h3 class="mt-4">METHOD</h3>

								<h4>
									Front End
								</h4>
								<p>
									VUE3 + VITE4
								</p>
<pre>
	<code class='python card bg-dark text-light'>
export default {
	data() {
		return {
		id: Math.floor(Math.random() * 100) + 1,
		isTalking: false,
		messageContent: "",
		roleAlias: { user: "ME", assistant: "GPT SIER", system: "System" },
		md: md,
		messageList: [
			{
			role: "assistant",
			content: `Hiï¼ŒI am an AI natural language model, I can provide some common services and information.`,
			},
		],
		};
	},
	watch: {
		messageList : {
		handler(newVal, oldVal) {
			this.scrollToBottom()
		},
		deep: true,
		immediate: true
		}
	},
	methods: {
		send() {
		if (!this.messageContent.length) return;
		this.sendChatMessage();
		},
		appendLastMessageContent(content: string){
		this.messageList[this.messageList.length - 1].content += content;
		},
		sendChatMessage() {
		try {
			const question = this.messageContent;
			this.isTalking = true;
			if (this.messageList.length === 2) {
			this.messageList.pop();
			}
			this.messageList.push({ role: "user", content: question});
			this.clearMessageContent();
			this.messageList.push({ role: "assistant", content: "" });
			
			fetch('/api', {
				method: 'POST',
				body: JSON.stringify({"id": this.id, question: question}),
				headers: {'Content-Type': 'application/json'}
			}).then(response => {
				const reader = response.body.getReader();
				const processChunk = async () => {
				const { done, value } = await reader.read();
				if (done) {return;}
				this.appendLastMessageContent(new TextDecoder('utf-8').decode(value))
				processChunk();
				};
	
				processChunk();
				}
			).catch(error => {
				console.error('Error:', error);
			});
			this.isTalking = false;
		} catch (error: any) {
			this.appendLastMessageContent(error);
		} finally {
			this.isTalking = false;
		}
		},
	
		clearMessageContent() {
		this.messageContent = ""
		},
		scrollToBottom() {
		let scrollElem = this.$refs.chatListDom;
		if (!scrollElem) return
		console.log("scroll", scrollElem.scrollHeight)
		window.scrollTo({
			top: scrollElem.scrollHeight, behavior: "smooth"
		})
		}
	}
	
	}
	</code>
</pre>
								
								<h4>
									Back End
								</h4>
								<p>Python</p>
<pre>
	<code class='python card bg-dark text-light'>
		
import openai
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import time
import threading

# Set the context round to 5 round
quantity = 10

# Init user infomation
user_status = [{"id": 0, "start":time.time(), "time": time.time(), "messages": [{"role": "system", "content": "You are a intelligent assistant."}]}]

class RequestHandler(BaseHTTPRequestHandler):
    def do_POST(self):

        print(self.path)
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)

        # Get the quetsion and save
        id = json.loads(post_data)['id']
        question = json.loads(post_data)['question']

        # Query historical records,
        # if the user already exists, accumulate questions and update the time,
        # if the user does not exist, add and insert.
        if id in [item.get("id") for item in user_status]:
            data = [item for item in user_status if item["id"] == id]

            # If greater than 5 rounds, delete the oldest.
            if len(data[0]['messages']) > quantity:
                data[0]['messages'] = data[0]['messages'][-quantity:]

            # If the interval exceeds 10 minutes, clear the user's history.
            if time.time() - data[0]['time'] >= 300:
                data[0]['messages'] = [{"role": "user", "content": question}]
            else:
                data[0]['messages'].append({"role": "user", "content": question})

            data[0]['time'] = time.time()
        else:
            user_status.append({"id": id, 
                                "start": time.time(), 
                                "time": time.time(), 
                                "messages": [{"role": "system", "content": "You are a intelligent assistant."}, {"role": "user", "content": question}]})

        # Set response headers, enable streaming
        self.send_response(200)
        self.send_header('Content-Type', 'text/plain')
        self.send_header('Transfer-Encoding', 'chunked')
        self.end_headers()

        # Call openai API
        openai.api_key = ""
        messages = [item for item in user_status if item["id"] == id][0]['messages']
        
        # Send the data stream chunk by chunk to the client
        print(messages)
        response_chunck_list = []
        for chunk in openai.ChatCompletion.create(model="gpt-3.5-turbo", messages=messages, stream=True):
            # Determine if it is the last block
            if chunk["choices"][0]['finish_reason'] == "stop": 
                self.wfile.write(b'0\r\n\r\n')
                self.wfile.flush()
            else:
                chunk_content = chunk["choices"][0]['delta']['content']
                response_chunck_list.append(chunk_content)

                if chunk_content != "":
                    chunk_content = chunk_content.encode('utf-8')
                    self.wfile.write(b'%X\r\n%s\r\n' % (len(chunk_content), chunk_content))
                    self.wfile.flush()

        if id in [item.get("id") for item in user_status]:
            data = [item for item in user_status if item["id"] == id]
            data[0]['messages'].append({"role": "assistant", "content": ''.join(response_chunck_list)})

if __name__ == '__main__':
        print("# start sier server 8998")
        server = HTTPServer(("0.0.0.0", 8998), RequestHandler)
        server.serve_forever()   
  
	</code>
</pre>
								
								<h3 class="mt-4">
									KEYWORDS
								</h3>
								<p class="text-dark">
									<strong>
										Microservice, Modularization, Sensor, Visualization, Data Processing, Machine Learning, and Video Streaming.
									</strong>
								</p>

							</div>

						</div>

						<!-- POST ASIDE -->
						<div class="col-md-4">
							<h3>EXPERIMENT</h3>
							<div class="row mb-5">
								<h4>WEB UI</h4>

								<figure class="figure-img text-center">
									<img class="img-responsive" src="assets/img/sier/1.png" alt="" width="100%">
									<p class="px-3 text-center">
										<small><strong>Figure 1.</strong> Assist in writing code.</small>
									</p>
								</figure>

								<figure class="figure-img text-center">
									<img class="img-responsive" src="assets/img/sier/2.png" alt="" width="100%">
									<p class="px-3 text-center">
										<small><strong>Figure 2.</strong> With context memory function.</small>
									</p>
								</figure>
							</div>

						</div>
						<!-- /aside -->
					</div>
					<!-- /row -->
				</div>
				<!-- /container -->
			</div>
			<!-- /section -->
		</main>


        <footer class="section bg-secondary mt-5 footer"></footer>
    </body>
</html>
